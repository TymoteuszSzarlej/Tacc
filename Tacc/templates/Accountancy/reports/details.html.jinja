{% extends 'base.html' %}

{% block content %}
<style>
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  .table-container {
    margin-bottom: 40px;
    display: flex;
    justify-content: center;
  }

  .table-responsive {
    width: 100%;
    max-width: 60vw;
  }

  .table-responsive table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
  }

  .table-responsive th,
  .table-responsive td {
    padding: 8px;
    border: 1px solid #dee2e6;
  }

  canvas {
    max-width: 100%;
    height: auto;
    margin: 20px auto;
    display: block;
  }

  @media (max-width: 576px) {
    .container {
      padding: 10px;
    }

    .table-responsive {
      max-width: 90vw;
    }
  }
</style>

<div class="container">
  <h2>üìä {{ report.name }}</h2>
  <p>{{ report.description }}</p>
  <h3>{{ report_data.type }}</h3>

  {% if report.report_type == 'balance_sheet' %}
    <!-- Assets -->
    <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead>
            <tr><th colspan="2">Bilans ‚Äì Aktywa</th></tr>
            <tr>
              <th>Aktywa</th>
              <th>Kwota</th>
            </tr>
          </thead>
          <tbody>
            {% for name, balance in report_data.assets.items %}
            <tr>
              <td>{{ name }}</td>
              <td>{{ balance|floatformat:2 }}</td>
            </tr>
            {% endfor %}
            <tr>
              <td><strong>Razem Aktywa</strong></td>
              <td><strong>{{ report_data.total_assets|floatformat:2 }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <canvas id="assetsChart"></canvas>

    <!-- Liabilities -->
    <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead>
            <tr><th colspan="2">Bilans ‚Äì Pasywa</th></tr>
            <tr>
              <th>Pasywa</th>
              <th>Kwota</th>
            </tr>
          </thead>
          <tbody>
            {% for name, balance in report_data.liabilities.items %}
            <tr>
              <td>{{ name }}</td>
              <td>{{ balance|floatformat:2 }}</td>
            </tr>
            {% endfor %}
            <tr>
              <td><strong>Razem Pasywa</strong></td>
              <td><strong>{{ report_data.total_liabilities|floatformat:2 }}</strong></td>
            </tr>
            <tr>
              <td><strong>Kapita≈Ç W≈Çasny</strong></td>
              <td><strong>{{ report_data.equity|floatformat:2 }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <canvas id="liabilitiesChart"></canvas>

  {% elif report.report_type == 'income_statement' %}
    <!-- Revenues -->
    <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead>
            <tr><th colspan="2">Przychody</th></tr>
            <tr>
              <th>Przychody</th>
              <th>Kwota</th>
            </tr>
          </thead>
          <tbody>
            {% for name, balance in report_data.revenues.items %}
            <tr>
              <td>{{ name }}</td>
              <td>{{ balance|floatformat:2 }}</td>
            </tr>
            {% endfor %}
            <tr>
              <td><strong>Razem Przychody</strong></td>
              <td><strong>{{ report_data.total_revenues|floatformat:2 }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <canvas id="revenuesChart"></canvas>

    <!-- Expenses -->
    <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead>
            <tr><th colspan="2">Koszty</th></tr>
            <tr>
              <th>Koszty</th>
              <th>Kwota</th>
            </tr>
          </thead>
          <tbody>
            {% for name, balance in report_data.expenses.items %}
            <tr>
              <td>{{ name }}</td>
              <td>{{ balance|floatformat:2 }}</td>
            </tr>
            {% endfor %}
            <tr>
              <td><strong>Razem Koszty</strong></td>
              <td><strong>{{ report_data.total_expenses|floatformat:2 }}</strong></td>
            </tr>
            <tr>
              <td><strong>Wynik Netto</strong></td>
              <td><strong>{{ report_data.net_income|floatformat:2 }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <canvas id="expensesChart"></canvas>

  {% elif report.report_type == 'cash_flow_statement' %}
    <!-- Cash Flow Statement -->
    <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead>
            <tr><th colspan="2">Rachunek Przep≈Çyw√≥w Pieniƒô≈ºnych</th></tr>
            <tr>
              <th>Kategoria</th>
              <th>Kwota</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dzia≈Çalno≈õƒá operacyjna -->
            <tr><td colspan="2" style="background-color: #f8f9fa; font-weight: bold;">Dzia≈Çalno≈õƒá operacyjna</td></tr>
            <tr>
              <td>Zysk netto</td>
              <td>{{ report_data.operating_activities.net_income|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>Amortyzacja</td>
              <td>{{ report_data.operating_activities.amortization|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>Zmiana w zapasach</td>
              <td>{{ report_data.operating_activities.change_in_inventory|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>Zmiana w nale≈ºno≈õciach</td>
              <td>{{ report_data.operating_activities.change_in_receivables|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>Zmiana w zobowiƒÖzaniach</td>
              <td>{{ report_data.operating_activities.change_in_liabilities|floatformat:2 }}</td>
            </tr>
            <tr>
              <td><strong>Razem przep≈Çywy z dzia≈Çalno≈õci operacyjnej</strong></td>
              <td><strong>{{ report_data.operating_activities.total|floatformat:2 }}</strong></td>
            </tr>
            
            <!-- Dzia≈Çalno≈õƒá inwestycyjna -->
            <tr><td colspan="2" style="background-color: #f8f9fa; font-weight: bold;">Dzia≈Çalno≈õƒá inwestycyjna</td></tr>
            <tr>
              <td>Zakup ≈õrodk√≥w trwa≈Çych</td>
              <td>{{ report_data.investing_activities.fixed_assets_purchases|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>Sprzeda≈º ≈õrodk√≥w trwa≈Çych</td>
              <td>{{ report_data.investing_activities.fixed_assets_sales|floatformat:2 }}</td>
            </tr>
            <tr>
              <td><strong>Razem przep≈Çywy z dzia≈Çalno≈õci inwestycyjnej</strong></td>
              <td><strong>{{ report_data.investing_activities.total|floatformat:2 }}</strong></td>
            </tr>
            
            <!-- Dzia≈Çalno≈õƒá finansowa -->
            <tr><td colspan="2" style="background-color: #f8f9fa; font-weight: bold;">Dzia≈Çalno≈õƒá finansowa</td></tr>
            <tr>
              <td>Kredyty i po≈ºyczki otrzymane</td>
              <td>{{ report_data.financing_activities.loans_received|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>Sp≈Çaty kredyt√≥w i po≈ºyczek</td>
              <td>{{ report_data.financing_activities.loans_repaid|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>Wyp≈Çaty dywidend</td>
              <td>{{ report_data.financing_activities.dividends_paid|floatformat:2 }}</td>
            </tr>
            <tr>
              <td><strong>Razem przep≈Çywy z dzia≈Çalno≈õci finansowej</strong></td>
              <td><strong>{{ report_data.financing_activities.total|floatformat:2 }}</strong></td>
            </tr>
            
            <!-- Podsumowanie -->
            <tr><td colspan="2" style="background-color: #e9ecef; font-weight: bold;">Podsumowanie</td></tr>
            <tr>
              <td>Zmiana stanu ≈õrodk√≥w pieniƒô≈ºnych netto</td>
              <td>{{ report_data.net_cash_flow|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>≈örodki pieniƒô≈ºne na poczƒÖtek okresu</td>
              <td>{{ report_data.cash_start|floatformat:2 }}</td>
            </tr>
            <tr>
              <td><strong>≈örodki pieniƒô≈ºne na koniec okresu</strong></td>
              <td><strong>{{ report_data.cash_end|floatformat:2 }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Wykres dla rachunku przep≈Çyw√≥w pieniƒô≈ºnych -->
    <canvas id="cashFlowChart"></canvas>

  {% else %}
    <p>Nieznany typ raportu.</p>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const config = (labels, data, colors) => ({
    type: 'pie',
    data: { labels, datasets: [{ data, backgroundColor: colors }] },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: ctx => {
              const lbl = ctx.label || '';
              const val = ctx.raw || 0;
              return `${lbl}: ${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PLN`;
            }
          }
        }
      }
    }
  });

  const barConfig = (labels, data, colors) => ({
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors,
        borderColor: colors.map(color => color.replace('0.7', '1')),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const val = ctx.raw || 0;
              return `${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PLN`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' PLN';
            }
          }
        }
      }
    }
  });

  {% if report.report_type == 'balance_sheet' %}
    new Chart(
      document.getElementById('assetsChart'),
      config(
        [{% for name in report_data.assets.keys %}"{{ name }}",{% endfor %}],
        [{% for balance in report_data.assets.values %}{{ balance }},{% endfor %}],
        ['#4e73df','#1cc88a','#36b9cc','#f6c23e','#e74a3b']
      )
    );

    new Chart(
      document.getElementById('liabilitiesChart'),
      config(
        [{% for name in report_data.liabilities.keys %}"{{ name }}",{% endfor %}],
        [{% for balance in report_data.liabilities.values %}{{ balance }},{% endfor %}],
        ['#858796','#fd7e14','#20c997','#6f42c1','#17a2b8']
      )
    );
  {% elif report.report_type == 'income_statement' %}
    new Chart(
      document.getElementById('revenuesChart'),
      config(
        [{% for name in report_data.revenues.keys %}"{{ name }}",{% endfor %}],
        [{% for balance in report_data.revenues.values %}{{ balance }},{% endfor %}],
        ['#28a745','#ffc107','#dc3545','#007bff','#6610f2']
      )
    );

    new Chart(
      document.getElementById('expensesChart'),
      config(
        [{% for name in report_data.expenses.keys %}"{{ name }}",{% endfor %}],
        [{% for balance in report_data.expenses.values %}{{ balance }},{% endfor %}],
        ['#6c757d','#e83e8c','#fd7e14','#20c997','#17a2b8']
      )
    );
  {% elif report.report_type == 'cash_flow_statement' %}
    // Wykres dla rachunku przep≈Çyw√≥w pieniƒô≈ºnych
    new Chart(
      document.getElementById('cashFlowChart'),
      barConfig(
        ['Dzia≈Çalno≈õƒá operacyjna', 'Dzia≈Çalno≈õƒá inwestycyjna', 'Dzia≈Çalno≈õƒá finansowa', 'Zmiana netto'],
        [
          {{ report_data.operating_activities.total }},
          {{ report_data.investing_activities.total }},
          {{ report_data.financing_activities.total }},
          {{ report_data.net_cash_flow }}
        ],
        ['rgba(40, 167, 69, 0.7)', 'rgba(0, 123, 255, 0.7)', 'rgba(108, 117, 125, 0.7)', 'rgba(255, 193, 7, 0.7)']
      )
    );
  {% endif %}
</script>
{% endblock %}